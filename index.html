<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recipe Scaler</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Unit conversion maps
        const VOLUME_CONVERSIONS = {
            // To teaspoons
            'tsp': 1,
            'teaspoon': 1,
            'teaspoons': 1,
            'tbsp': 3,
            'tablespoon': 3,
            'tablespoons': 3,
            'floz': 6,
            'fl oz': 6,
            'fluid ounce': 6,
            'fluid ounces': 6,
            'cup': 48,
            'cups': 48,
            'c': 48,
            'pint': 96,
            'pints': 96,
            'pt': 96,
            'quart': 192,
            'quarts': 192,
            'qt': 192,
            'gallon': 768,
            'gallons': 768,
            'gal': 768,
            // Metric
            'ml': 0.202884,
            'milliliter': 0.202884,
            'milliliters': 0.202884,
            'l': 202.884,
            'liter': 202.884,
            'liters': 202.884,
        };

        const WEIGHT_CONVERSIONS = {
            // To grams
            'g': 1,
            'gram': 1,
            'grams': 1,
            'kg': 1000,
            'kilogram': 1000,
            'kilograms': 1000,
            'oz': 28.3495,
            'ounce': 28.3495,
            'ounces': 28.3495,
            'lb': 453.592,
            'lbs': 453.592,
            'pound': 453.592,
            'pounds': 453.592,
        };

        // Smart unit conversion for display following chef-friendly decision tree
        const smartConvertVolume = (tsp, useMetric) => {
            if (useMetric) {
                const ml = tsp / 0.202884;
                if (ml >= 1000) {
                    const liters = Math.floor(ml / 1000);
                    const remainingMl = Math.round(ml - (liters * 1000));
                    if (remainingMl >= 10) {
                        return { value: liters, unit: 'L', remainder: remainingMl, remainderUnit: 'ml' };
                    }
                    return { value: Math.round(ml / 1000 * 100) / 100, unit: 'L' };
                }
                return { value: Math.round(ml), unit: 'ml' };
            } else {
                // Decision tree for US measurements
                
                // Step 1: Convert to cups
                const cups = tsp / 48;
                
                // Step 7: If smaller than ⅛ tsp, use "a pinch"
                if (tsp < 0.125) {
                    return { value: 0, unit: 'pinch' };
                }
                
                // Step 6: Less than ¼ cup (12 tsp) → convert to teaspoons, round to nearest ¼ tsp
                if (cups < 0.25) {
                    const roundedTsp = Math.round(tsp * 4) / 4;
                    return { value: roundedTsp, unit: 'tsp' };
                }
                
                // Step 5: Between ¼ cup and 1 cup → convert to tablespoons, round to nearest ¼ tbsp
                if (cups >= 0.25 && cups < 1) {
                    const tbsp = tsp / 3;
                    const roundedTbsp = Math.round(tbsp * 4) / 4;
                    return { value: roundedTbsp, unit: 'tbsp' };
                }
                
                // Step 2: 8 cups or more → use quarts, round to nearest ¼ quart
                if (cups >= 8) {
                    const quarts = cups / 4;
                    const roundedQuarts = Math.round(quarts * 4) / 4;
                    return { value: roundedQuarts, unit: 'qt' };
                }
                
                // Step 3: Between 4 and 8 cups → prefer quarts, but break down if leftover is awkward
                if (cups >= 4 && cups < 8) {
                    const quarts = Math.floor(cups / 4);
                    const remainingCups = cups - (quarts * 4);
                    
                    // Round remaining cups to nearest ¼ cup
                    const roundedRemainingCups = Math.round(remainingCups * 4) / 4;
                    
                    // If remaining cups is awkward (less than ¼ cup), convert to tbsp/tsp
                    if (roundedRemainingCups > 0 && roundedRemainingCups < 0.25) {
                        const remainingTsp = remainingCups * 48;
                        if (remainingTsp >= 3) {
                            const tbsp = Math.round(remainingTsp / 3 * 4) / 4;
                            return { value: quarts, unit: 'qt', remainder: tbsp, remainderUnit: 'tbsp' };
                        } else {
                            const roundedTsp = Math.round(remainingTsp * 4) / 4;
                            return { value: quarts, unit: 'qt', remainder: roundedTsp, remainderUnit: 'tsp' };
                        }
                    }
                    
                    // Otherwise show quarts + cups if cups >= ¼
                    if (roundedRemainingCups >= 0.25) {
                        return { value: quarts, unit: 'qt', remainder: roundedRemainingCups, remainderUnit: 'cup' };
                    }
                    
                    // Just quarts if no significant remainder
                    return { value: quarts, unit: 'qt' };
                }
                
                // Step 4: Between 1 and 4 cups → display in cups
                // Round to nearest ¼ cup or ⅓ cup (whichever is closer)
                const roundedQuarterCup = Math.round(cups * 4) / 4;
                const roundedThirdCup = Math.round(cups * 3) / 3;
                
                // Choose whichever is closer to the original value
                const quarterDiff = Math.abs(cups - roundedQuarterCup);
                const thirdDiff = Math.abs(cups - roundedThirdCup);
                
                const roundedCups = thirdDiff < quarterDiff ? roundedThirdCup : roundedQuarterCup;
                return { value: roundedCups, unit: 'cup' };
            }
        };

        const smartConvertWeight = (g, useMetric) => {
            if (useMetric) {
                if (g >= 1000) {
                    const kg = Math.floor(g / 1000);
                    const remainingG = Math.round(g - (kg * 1000));
                    if (remainingG >= 50) { // Only show grams if 50g or more
                        return { value: kg, unit: 'kg', remainder: remainingG, remainderUnit: 'g' };
                    }
                    return { value: g / 1000, unit: 'kg' };
                }
                return { value: Math.round(g), unit: 'g' };
            } else {
                if (g >= 453.592) {
                    const lb = Math.floor(g / 453.592);
                    const remainingG = g - (lb * 453.592);
                    if (remainingG >= 28.3495) { // 1+ oz remaining
                        const oz = Math.round(remainingG / 28.3495);
                        return { value: lb, unit: 'lb', remainder: oz, remainderUnit: 'oz' };
                    }
                    return { value: g / 453.592, unit: 'lb' };
                }
                return { value: Math.round(g / 28.3495 * 10) / 10, unit: 'oz' }; // Round to nearest 0.1 oz
            }
        };

        // Helper to format compound measurements
        const formatCompoundMeasurement = (scaled) => {
            if (scaled.remainder && scaled.remainderUnit) {
                // Two-part compound measurement
                return (
                    <>
                        {formatNumber(scaled.value)} {pluralize(scaled.value, scaled.unit)}
                        <span className="text-gray-300"> + </span>
                        {formatNumber(scaled.remainder)} {pluralize(scaled.remainder, scaled.remainderUnit)}
                    </>
                );
            }
            return <>{formatNumber(scaled.value)} {pluralize(scaled.value, scaled.unit)}</>;
        };

        // Parse ingredient line
        const parseIngredient = (line, rangeMode = 'average') => {
            line = line.trim();
            if (!line) return null;

            // Remove common prefixes
            line = line.replace(/^[-•*]\s*/, '');
            
            // Normalize dashes - convert en dash (–) and em dash (—) to regular hyphen (-)
            line = line.replace(/[–—]/g, '-');
            
            // Ignore header lines (all caps or common recipe section headers)
            if (line.match(/^(ingredients|directions|instructions|serves|servings|yield|method|preparation|notes?|tips?)/i)) {
                return null;
            }
            
            // Ignore all-caps lines (likely section headers)
            if (line === line.toUpperCase() && line.length > 3 && /[A-Z]/.test(line)) {
                return null;
            }
            
            // Store original for "to taste" handling
            const originalLine = line;
            
            // Remove parenthetical notes but keep them for reference
            const parenMatch = line.match(/^(.+?)(\([^)]+\).*)$/);
            let notes = '';
            if (parenMatch) {
                line = parenMatch[1].trim();
                notes = parenMatch[2].trim();
            }
            
            // Handle "to taste" - these are non-quantifiable
            if (line.match(/to taste/i)) {
                // Extract ingredient name before "to taste"
                const ingredient = line.replace(/,?\s*to taste.*/i, '').trim();
                return {
                    original: originalLine,
                    quantity: null,
                    unit: 'to taste',
                    ingredient: ingredient,
                    type: 'seasoning',
                    baseValue: 0,
                    isRange: false,
                    rangeOriginal: null,
                    notes: notes
                };
            }
            
            // Try to match: quantity unit ingredient
            // Supports: "2 cups flour", "1/2 cup sugar", "2 1/2 cups water", "2-1/2 cups" (mixed fraction), "1.5 tsp salt", "2.25 cups milk", "2-3 cups water", "3 eggs"
            const patterns = [
                // Decimal with unit: "2.25 cups" or "10.5 tablespoons"
                /^(\d+\.\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                // Decimal range with unit: "1.5-3 teaspoons"
                /^(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s+([a-zA-Z]+)\s+(.+)$/,
                // Whole number + unicode fraction with space: "1 ½ cups"
                /^(\d+)\s+([½⅓⅔¼¾⅛⅜⅝⅞])\s+([a-zA-Z]+)\s+(.+)$/,
                // Whole number + unicode fraction (no space): "1½ cups"
                /^(\d+)([½⅓⅔¼¾⅛⅜⅝⅞])\s+([a-zA-Z]+)\s+(.+)$/,
                // Mixed fraction with unit: "2 1/2 cups"
                /^(\d+)\s+(\d+\/\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                // Ambiguous: could be range or mixed fraction: "2-1/2 cups" or "1-2 cups"
                /^(\d+)\s*-\s*(\d+\/\d+|\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                // Range with mixed fractions: "1 1/2-2 cups" or "2-2 1/2 cups"
                /^(\d+)\s+(\d+\/\d+)\s*-\s*(\d+)\s+(\d+\/\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                /^(\d+)\s*-\s*(\d+)\s+(\d+\/\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                /^(\d+)\s+(\d+\/\d+)\s*-\s*(\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                // Standalone fraction with unit: "1/4 cup" or "1/2 tsp"
                /^(\d+\/\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                // Fraction or decimal with unit (with range support)
                /^(\d+\/\d+|\d+\.\d+)\s*-\s*(\d+\/\d+|\d+\.\d+)\s*([a-zA-Z]+)\s+(.+)$/,
                // Just number with unit
                /^(\d+)\s+([a-zA-Z]+)\s+(.+)$/,
                // Unicode fraction with unit
                /^([½⅓⅔¼¾⅛⅜⅝⅞])\s*([a-zA-Z]+)\s+(.+)$/,
                // Mixed fraction count: "2 1/2 eggs"
                /^(\d+)\s+(\d+\/\d+)\s+(.+)$/,
                // Standalone fraction count: "1/2 onion"
                /^(\d+\/\d+)\s+(.+)$/,
                // Ambiguous count: "2-1/2 eggs" or "2-3 eggs"
                /^(\d+)\s*-\s*(\d+\/\d+|\d+)\s+(.+)$/,
                // Count with range: "2-3 eggs"
                /^(\d+\/\d+|\d+\.\d+)\s*-\s*(\d+\/\d+|\d+\.\d+)\s+(.+)$/,
                // Unicode fraction count only
                /^([½⅓⅔¼¾⅛⅜⅝⅞])\s+(.+)$/,
                // Simple count: "4 eggs" or "3 potatoes"
                /^(\d+)\s+(.+)$/,
            ];

            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    let quantity, unit, ingredient, isRange = false, rangeOriginal = null;
                    
                    // Handle decimal with unit: "2.25 cups milk"
                    if (pattern === patterns[0]) {
                        quantity = parseFloat(match[1]);
                        unit = match[2].toLowerCase();
                        ingredient = match[3];
                    }
                    // Handle decimal range with unit: "1.5-3 teaspoons"
                    else if (pattern === patterns[1]) {
                        const q1 = parseFloat(match[1]);
                        const q2 = parseFloat(match[2]);
                        isRange = true;
                        rangeOriginal = `${match[1]}-${match[2]}`;
                        quantity = rangeMode === 'low' ? q1 : rangeMode === 'high' ? q2 : (q1 + q2) / 2;
                        unit = match[3].toLowerCase();
                        ingredient = match[4];
                    }
                    // Handle whole number + unicode fraction with space: "1 ½ tsp"
                    else if (pattern === patterns[2]) {
                        const whole = parseInt(match[1]);
                        const frac = parseUnicodeFraction(match[2]);
                        quantity = whole + frac;
                        unit = match[3].toLowerCase();
                        ingredient = match[4];
                    }
                    // Handle whole number + unicode fraction (no space): "1½ lbs"
                    else if (pattern === patterns[3]) {
                        const whole = parseInt(match[1]);
                        const frac = parseUnicodeFraction(match[2]);
                        quantity = whole + frac;
                        unit = match[3].toLowerCase();
                        ingredient = match[4];
                    }
                    // Handle mixed fractions with unit: "2 1/2 cups flour"
                    else if (pattern === patterns[4]) {
                        const whole = parseInt(match[1]);
                        const frac = parseQuantity(match[2]);
                        quantity = whole + frac;
                        unit = match[3].toLowerCase();
                        ingredient = match[4];
                    }
                    // Handle ambiguous "2-1/2" format with unit - could be range or mixed fraction
                    else if (pattern === patterns[5]) {
                        const q1 = parseInt(match[1]);
                        const q2 = parseQuantity(match[2]);
                        
                        // If q1 > q2, treat as mixed fraction (e.g., "2-1/2" = 2.5)
                        // If q1 < q2, treat as range (e.g., "1-2" = range from 1 to 2)
                        if (q1 > q2) {
                            // Mixed fraction: "2-1/2 cups" = 2.5 cups
                            quantity = q1 + q2;
                            unit = match[3].toLowerCase();
                            ingredient = match[4];
                        } else {
                            // Valid range: "1-2 cups"
                            isRange = true;
                            rangeOriginal = `${match[1]}-${match[2]}`;
                            quantity = rangeMode === 'low' ? q1 : rangeMode === 'high' ? q2 : (q1 + q2) / 2;
                            unit = match[3].toLowerCase();
                            ingredient = match[4];
                        }
                    }
                    // Handle mixed fraction ranges with unit
                    else if (pattern === patterns[6] || pattern === patterns[7] || pattern === patterns[8]) {
                        isRange = true;
                        let q1, q2;
                        if (pattern === patterns[6]) {
                            // "1 1/2-2 1/2 cups"
                            q1 = parseInt(match[1]) + parseQuantity(match[2]);
                            q2 = parseInt(match[3]) + parseQuantity(match[4]);
                            rangeOriginal = `${match[1]} ${match[2]}-${match[3]} ${match[4]}`;
                            unit = match[5].toLowerCase();
                            ingredient = match[6];
                        } else if (pattern === patterns[7]) {
                            // "2-2 1/2 cups"
                            q1 = parseInt(match[1]);
                            q2 = parseInt(match[2]) + parseQuantity(match[3]);
                            rangeOriginal = `${match[1]}-${match[2]} ${match[3]}`;
                            unit = match[4].toLowerCase();
                            ingredient = match[5];
                        } else {
                            // "2 1/2-3 cups"
                            q1 = parseInt(match[1]) + parseQuantity(match[2]);
                            q2 = parseInt(match[3]);
                            rangeOriginal = `${match[1]} ${match[2]}-${match[3]}`;
                            unit = match[4].toLowerCase();
                            ingredient = match[5];
                        }
                        quantity = rangeMode === 'low' ? q1 : rangeMode === 'high' ? q2 : (q1 + q2) / 2;
                    }
                    // Standalone fraction with unit: "1/4 cup honey"
                    else if (pattern === patterns[9]) {
                        quantity = parseQuantity(match[1]);
                        unit = match[2].toLowerCase();
                        ingredient = match[3];
                    }
                    // Fraction/decimal range: "1/2-3/4 cups"
                    else if (pattern === patterns[10]) {
                        const q1 = parseQuantity(match[1]);
                        const q2 = parseQuantity(match[2]);
                        isRange = true;
                        rangeOriginal = `${match[1]}-${match[2]}`;
                        quantity = rangeMode === 'low' ? q1 : rangeMode === 'high' ? q2 : (q1 + q2) / 2;
                        unit = match[3].toLowerCase();
                        ingredient = match[4];
                    }
                    // Mixed fraction count: "2 1/2 eggs"
                    else if (pattern === patterns[13]) {
                        const whole = parseInt(match[1]);
                        const frac = parseQuantity(match[2]);
                        quantity = whole + frac;
                        ingredient = match[3];
                        
                        // Clean up ingredient (remove commas and descriptions after comma)
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                        
                        return {
                            original: originalLine,
                            quantity,
                            unit: 'count',
                            ingredient: ingredient,
                            type: 'count',
                            baseValue: quantity,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                    // Standalone fraction count: "1/2 onion"
                    else if (pattern === patterns[14]) {
                        quantity = parseQuantity(match[1]);
                        ingredient = match[2];
                        
                        // Clean up ingredient (remove commas and descriptions after comma)
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                        
                        // Check if this might actually be a unit-based ingredient
                        const firstWord = ingredient.split(/\s+/)[0]?.toLowerCase();
                        if (VOLUME_CONVERSIONS[firstWord] || WEIGHT_CONVERSIONS[firstWord]) {
                            // This is actually "1/2 cup something" - continue to next pattern
                            continue;
                        }
                        
                        return {
                            original: originalLine,
                            quantity,
                            unit: 'count',
                            ingredient: ingredient,
                            type: 'count',
                            baseValue: quantity,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                    // Handle ambiguous "2-1/2" format for count - could be range or mixed fraction
                    else if (pattern === patterns[15]) {
                        const q1 = parseInt(match[1]);
                        const q2 = parseQuantity(match[2]);
                        
                        // If q1 > q2, treat as mixed fraction (e.g., "2-1/2" = 2.5)
                        // If q1 < q2, treat as range (e.g., "1-2" = range from 1 to 2)
                        if (q1 > q2) {
                            // Mixed fraction: "2-1/2 eggs" = 2.5 eggs
                            quantity = q1 + q2;
                            ingredient = match[3];
                        } else {
                            // Valid range: "1-2 eggs"
                            isRange = true;
                            rangeOriginal = `${match[1]}-${match[2]}`;
                            quantity = rangeMode === 'low' ? q1 : rangeMode === 'high' ? q2 : (q1 + q2) / 2;
                            ingredient = match[3];
                        }
                        
                        // Clean up ingredient (remove commas and descriptions after comma)
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                        
                        return {
                            original: originalLine,
                            quantity,
                            unit: 'count',
                            ingredient: ingredient,
                            type: 'count',
                            baseValue: quantity,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                    // Fraction/decimal range for count
                    else if (pattern === patterns[16]) {
                        const q1 = parseQuantity(match[1]);
                        const q2 = parseQuantity(match[2]);
                        isRange = true;
                        rangeOriginal = `${match[1]}-${match[2]}`;
                        quantity = rangeMode === 'low' ? q1 : rangeMode === 'high' ? q2 : (q1 + q2) / 2;
                        ingredient = match[3];
                        
                        // Clean up ingredient (remove commas and descriptions after comma)
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                        
                        return {
                            original: originalLine,
                            quantity,
                            unit: 'count',
                            ingredient: ingredient,
                            type: 'count',
                            baseValue: quantity,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                    // Unicode fraction count: "½ onion"
                    else if (pattern === patterns[17]) {
                        quantity = parseUnicodeFraction(match[1]);
                        ingredient = match[2];
                        
                        // Clean up ingredient (remove commas and descriptions after comma)
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                        
                        return {
                            original: originalLine,
                            quantity,
                            unit: 'count',
                            ingredient: ingredient,
                            type: 'count',
                            baseValue: quantity,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                    // Simple count: "4 chicken thighs" - LAST RESORT (most general)
                    else if (pattern === patterns[18]) {
                        quantity = parseInt(match[1]);
                        ingredient = match[2];
                        
                        // Clean up ingredient (remove commas and descriptions after comma)
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                        
                        // Only treat as count if it doesn't look like it should have a unit
                        // Check if the next word after the number is a known unit
                        const firstWord = ingredient.split(/\s+/)[0]?.toLowerCase();
                        if (VOLUME_CONVERSIONS[firstWord] || WEIGHT_CONVERSIONS[firstWord]) {
                            // This is actually a unit-based ingredient, let it fall through
                            continue;
                        }
                        
                        return {
                            original: originalLine,
                            quantity,
                            unit: 'count',
                            ingredient: ingredient,
                            type: 'count',
                            baseValue: quantity,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                    // Simple unit-based
                    else if (pattern === patterns[11]) {
                        quantity = parseQuantity(match[1]);
                        unit = match[2].toLowerCase();
                        ingredient = match[3];
                    }
                    // Unicode fraction with unit
                    else if (pattern === patterns[12]) {
                        quantity = parseUnicodeFraction(match[1]);
                        unit = match[2].toLowerCase();
                        ingredient = match[3];
                    }

                    // Clean up ingredient (remove commas and descriptions after comma)
                    if (ingredient) {
                        ingredient = ingredient.replace(/,.*$/, '').trim();
                    }

                    // Determine if volume or weight
                    let type = null;
                    let baseValue = null;

                    if (unit && VOLUME_CONVERSIONS[unit]) {
                        type = 'volume';
                        baseValue = quantity * VOLUME_CONVERSIONS[unit];
                    } else if (unit && WEIGHT_CONVERSIONS[unit]) {
                        type = 'weight';
                        baseValue = quantity * WEIGHT_CONVERSIONS[unit];
                    }

                    if (type) {
                        return {
                            original: originalLine,
                            quantity,
                            unit,
                            ingredient: ingredient,
                            type,
                            baseValue,
                            isRange,
                            rangeOriginal,
                            notes
                        };
                    }
                }
            }

            return null; // Couldn't parse
        };

        const parseQuantity = (str) => {
            // Handle fractions like "1/2"
            if (str.includes('/')) {
                const [num, denom] = str.split('/').map(Number);
                return num / denom;
            }
            return parseFloat(str);
        };

        const parseUnicodeFraction = (str) => {
            const fractions = {
                '½': 0.5, '⅓': 0.333, '⅔': 0.667,
                '¼': 0.25, '¾': 0.75,
                '⅛': 0.125, '⅜': 0.375, '⅝': 0.625, '⅞': 0.875
            };
            return fractions[str] || 1;
        };

        const formatNumber = (num) => {
            // Handle special case for pinch
            if (num === 0) return 'a';
            
            if (num % 1 === 0) return num.toString();
            
            // Try to convert to fraction if close
            const fractions = [
                [0.125, '⅛'], [0.167, '⅙'], [0.25, '¼'], [0.333, '⅓'], [0.375, '⅜'],
                [0.5, '½'], [0.625, '⅝'], [0.667, '⅔'], [0.75, '¾'], [0.833, '⅚'], [0.875, '⅞']
            ];
            
            const decimal = num % 1;
            const whole = Math.floor(num);
            
            for (const [val, frac] of fractions) {
                if (Math.abs(decimal - val) < 0.02) { // Slightly more tolerance for thirds
                    return whole > 0 ? `${whole} ${frac}` : frac;
                }
            }
            
            return num.toFixed(2).replace(/\.?0+$/, '');
        };

        const pluralize = (num, unit) => {
            // Round to check if singular or plural
            const roundedNum = Math.round(num * 100) / 100;
            
            // If exactly 1, use singular
            if (roundedNum === 1) return unit;
            
            // Common pluralization rules
            const lowerUnit = unit.toLowerCase();
            
            // Already plural
            if (lowerUnit.endsWith('s') || lowerUnit.endsWith('es')) return unit;
            
            // Special cases
            const specialPlurals = {
                'leaf': 'leaves',
                'clove': 'cloves',
                'bulb': 'bulbs',
                'pinch': 'pinches',
                'dash': 'dashes',
                'inch': 'inches',
                'bunch': 'bunches',
                'sprig': 'sprigs',
                'stick': 'sticks',
                'cube': 'cubes',
                'rasher': 'rashers',
                'slice': 'slices',
                'piece': 'pieces',
            };
            
            if (specialPlurals[lowerUnit]) {
                return specialPlurals[lowerUnit];
            }
            
            // Default: add 's'
            return unit + 's';
        };

        function RecipeScaler() {
            const [inputText, setInputText] = useState('');
            const [originalServings, setOriginalServings] = useState(4);
            const [targetServings, setTargetServings] = useState(8);
            const [useMetric, setUseMetric] = useState(false);
            const [parsedIngredients, setParsedIngredients] = useState([]);
            const [unparsedLines, setUnparsedLines] = useState([]);
            const [savedRecipes, setSavedRecipes] = useState([]);
            const [recipeName, setRecipeName] = useState('');
            const [showSaved, setShowSaved] = useState(false);
            const [rangeHandling, setRangeHandling] = useState('average'); // 'low', 'average', 'high'
            const [copySuccess, setCopySuccess] = useState(false);
            const [unitOverrides, setUnitOverrides] = useState({}); // Track individual ingredient unit preferences
            const [currentPage, setCurrentPage] = useState('scaler'); // 'scaler' or 'settings'
            const [customConversions, setCustomConversions] = useState({});
            const [newConversionFrom, setNewConversionFrom] = useState('');
            const [newConversionTo, setNewConversionTo] = useState('');
            const [newConversionRatio, setNewConversionRatio] = useState('');
            const [newConversionNote, setNewConversionNote] = useState('');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [editingKey, setEditingKey] = useState(null);
            const [editValues, setEditValues] = useState({ to: '', ratio: '', note: '' });

            // Common ambiguous items that should show warnings
            const AMBIGUOUS_ITEMS = {
                // Imprecise measurements
                'pinch': { measurement: '~1/16 tsp (0.3 mL)', note: 'Amount held between thumb + forefinger' },
                'dash': { measurement: '~1/8 tsp (0.6 mL)', note: 'Often a bit more than a pinch' },
                'smidgen': { measurement: '~1/32 tsp (0.15 mL)', note: 'Half a pinch; rarely used' },
                'drop': { measurement: '~0.05 mL', note: 'A literal droplet' },
                'hint': { measurement: '~1/32–1/16 tsp', note: 'Very small flavor amount; inconsistent' },
                'sprinkle': { measurement: '1 pinch to 1 tsp', note: 'Depends heavily on ingredient' },
                'dusting': { measurement: '~1–2 tsp', note: 'Very thin layer, usually powdered sugar or cocoa' },
                'drizzle': { measurement: '1–2 tsp', note: 'Thin liquid stream' },
                'splash': { measurement: '1–2 tsp', note: 'Liquids like vinegar or wine' },
                'glug': { measurement: '1–2 tbsp', note: 'Sound-based measure, usually olive oil' },
                'handful': { measurement: '1/4 to 1 cup', note: "Depends on the cook's hand" },
                
                // Heaping/scant measurements
                'heaping': { measurement: '10–20% over level', note: 'Mounded measurement' },
                'rounded': { measurement: '~1.25x level', note: 'Similar to heaping' },
                'scant': { measurement: '10–20% under level', note: 'Slightly less than level' },
                
                // Size descriptors
                'small': { measurement: 'Varies by item', note: 'Subjective size descriptor' },
                'medium': { measurement: 'Varies by item', note: 'Subjective size descriptor' },
                'large': { measurement: 'Varies by item', note: 'Subjective size descriptor' },
                
                // Garlic
                'clove': { measurement: '3–7 g each', note: 'Garlic clove size varies significantly' },
                'cloves': { measurement: '3–7 g each', note: 'Garlic clove size varies significantly' },
                'bulb': { measurement: '10-15 cloves', note: 'Garlic bulb size varies by type' },
                'bulbs': { measurement: '10-15 cloves', note: 'Garlic bulb size varies by type' },
                'head': { measurement: '10-15 cloves', note: 'Garlic head size varies by type' },
                'heads': { measurement: '10-15 cloves', note: 'Garlic head size varies by type' },
                
                // Ginger
                'knob': { measurement: '1–2 tbsp grated (10–20 g)', note: 'Thumb-sized piece' },
                
                // Herbs
                'sprig': { measurement: '2–4 in long, ~1 tsp chopped', note: 'Size varies (thyme, rosemary, etc.)' },
                'sprigs': { measurement: '2–4 in long, ~1 tsp chopped', note: 'Size varies (thyme, rosemary, etc.)' },
                'bunch': { measurement: '1–2 oz (30–60 g)', note: 'Very inconsistent measurement' },
                'bunches': { measurement: '1–2 oz (30–60 g)', note: 'Very inconsistent measurement' },
                'leaf': { measurement: '0.5–1 g each', note: 'Size varies (basil, mint, etc.)' },
                'leaves': { measurement: '0.5–1 g each', note: 'Size varies (basil, mint, etc.)' },
                
                // Butter
                'stick': { measurement: '1/2 cup (113 g)', note: 'U.S. standard stick of butter' },
                'cube': { measurement: '1 tbsp (14 g)', note: 'Often 1 tbsp piece of butter' },
                
                // Meat cuts
                'slab': { measurement: 'No standard', note: 'Context needed for size' },
                'rasher': { measurement: '1 slice', note: 'Common in UK/Canada for bacon' },
                'fillet': { measurement: '1 whole piece', note: 'Size depends on fish/cut' },
                'filet': { measurement: '1 whole piece', note: 'Size depends on fish/cut' },
                
                // Containers
                'can': { measurement: 'Varies', note: 'Container sizes vary by brand' },
                'cans': { measurement: 'Varies', note: 'Container sizes vary by brand' },
                'jar': { measurement: 'Varies', note: 'Container sizes vary by brand' },
                'jars': { measurement: 'Varies', note: 'Container sizes vary by brand' },
            };

            // Load saved recipes from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('savedRecipes');
                if (saved) {
                    setSavedRecipes(JSON.parse(saved));
                }
                
                const conversions = localStorage.getItem('customConversions');
                if (conversions) {
                    setCustomConversions(JSON.parse(conversions));
                } else {
                    // Set common default conversions on first load
                    const defaultConversions = {
                        // Imprecise Measurements
                        'pinch': { to: 'tsp', ratio: 0.0625, note: '~1/16 tsp, thumb + forefinger' },
                        'dash': { to: 'tsp', ratio: 0.125, note: '~1/8 tsp' },
                        'smidgen': { to: 'tsp', ratio: 0.03125, note: '~1/32 tsp, half a pinch' },
                        'drop': { to: 'ml', ratio: 0.05, note: 'Literal droplet' },
                        'hint': { to: 'tsp', ratio: 0.04, note: '~1/32-1/16 tsp, very small' },
                        'sprinkle': { to: 'tsp', ratio: 0.5, note: '1 pinch to 1 tsp, varies' },
                        'dusting': { to: 'tsp', ratio: 1.5, note: 'Thin layer, 1-2 tsp' },
                        'drizzle': { to: 'tsp', ratio: 1.5, note: 'Thin liquid stream' },
                        'splash': { to: 'tsp', ratio: 1.5, note: 'Liquids like vinegar or wine' },
                        'glug': { to: 'tbsp', ratio: 1.5, note: 'Sound-based, usually olive oil' },
                        'handful': { to: 'cup', ratio: 0.5, note: "1/4 to 1 cup, depends on hand" },
                        
                        // Modified Measurements
                        'heaping teaspoon': { to: 'tsp', ratio: 1.15, note: '10-20% over level' },
                        'heaping tablespoon': { to: 'tbsp', ratio: 1.15, note: '10-20% over level' },
                        'rounded tablespoon': { to: 'tbsp', ratio: 1.25, note: 'Similar to heaping' },
                        'scant teaspoon': { to: 'tsp', ratio: 0.85, note: '10-20% under level' },
                        'scant tablespoon': { to: 'tbsp', ratio: 0.85, note: '10-20% under level' },
                        'scant cup': { to: 'fl oz', ratio: 7.5, note: 'Just under 8 oz' },
                        
                        // Garlic
                        'garlic clove': { to: 'garlic bulbs', ratio: 0.0833, note: '12 cloves per bulb' },
                        'garlic bulb': { to: 'cloves', ratio: 12, note: '10-15 cloves typical' },
                        'garlic head': { to: 'cloves', ratio: 12, note: 'Same as bulb' },
                        'clove': { to: 'garlic bulbs', ratio: 0.0833, note: '12 cloves per bulb' },
                        
                        // Ginger
                        'knob of ginger': { to: 'tbsp grated', ratio: 1.5, note: 'Thumb-sized piece (10-20g)' },
                        'knob ginger': { to: 'tbsp grated', ratio: 1.5, note: 'Thumb-sized piece (10-20g)' },
                        
                        // Herbs
                        'sprig': { to: 'tsp chopped', ratio: 1, note: '2-4 in long (thyme, rosemary)' },
                        'bunch parsley': { to: 'oz', ratio: 1.5, note: '1-2 oz (30-60g), very inconsistent' },
                        'bunch cilantro': { to: 'oz', ratio: 1.5, note: '1-2 oz (30-60g), very inconsistent' },
                        'bunch basil': { to: 'oz', ratio: 1.5, note: '1-2 oz (30-60g), very inconsistent' },
                        'basil leaf': { to: 'g', ratio: 0.75, note: '0.5-1g each' },
                        'mint leaf': { to: 'g', ratio: 0.75, note: '0.5-1g each' },
                        
                        // Butter
                        'stick of butter': { to: 'cup', ratio: 0.5, note: 'U.S. standard (113g)' },
                        'stick butter': { to: 'tbsp', ratio: 8, note: 'U.S. standard (113g)' },
                        'cube of butter': { to: 'tbsp', ratio: 1, note: 'Often 1 tbsp piece (14g)' },
                        
                        // Meat Cuts
                        'rasher': { to: 'slice', ratio: 1, note: 'Common in UK/Canada for bacon' },
                        
                        // Common Vegetables
                        'small onion': { to: 'cup chopped', ratio: 0.75, note: 'Diced' },
                        'medium onion': { to: 'cup chopped', ratio: 1.5, note: 'Diced' },
                        'large onion': { to: 'cup chopped', ratio: 2, note: 'Diced' },
                        'small carrot': { to: 'cup chopped', ratio: 0.33, note: 'Diced' },
                        'medium carrot': { to: 'cup chopped', ratio: 0.5, note: 'Diced' },
                        'large carrot': { to: 'cup chopped', ratio: 0.75, note: 'Diced' },
                        
                        // Citrus
                        'small lemon': { to: 'tbsp juice', ratio: 2, note: 'Fresh lemon' },
                        'medium lemon': { to: 'tbsp juice', ratio: 3, note: 'Fresh lemon' },
                        'large lemon': { to: 'tbsp juice', ratio: 4, note: 'Fresh lemon' },
                        'medium lime': { to: 'tbsp juice', ratio: 2, note: 'Fresh lime' },
                        
                        // Containers
                        'can tomatoes': { to: 'oz', ratio: 14.5, note: 'Standard can size' },
                        'small can': { to: 'oz', ratio: 8, note: 'Typical small can' },
                    };
                    setCustomConversions(defaultConversions);
                    localStorage.setItem('customConversions', JSON.stringify(defaultConversions));
                }
            }, []);

            const addCustomConversion = () => {
                if (!newConversionFrom || !newConversionTo || !newConversionRatio) {
                    alert('Please fill in From, To, and Ratio fields');
                    return;
                }
                
                const ratio = parseFloat(newConversionRatio);
                if (isNaN(ratio) || ratio <= 0) {
                    alert('Ratio must be a positive number');
                    return;
                }
                
                const updated = {
                    ...customConversions,
                    [newConversionFrom.toLowerCase()]: {
                        to: newConversionTo.toLowerCase(),
                        ratio: ratio,
                        note: newConversionNote || ''
                    }
                };
                
                setCustomConversions(updated);
                localStorage.setItem('customConversions', JSON.stringify(updated));
                
                setNewConversionFrom('');
                setNewConversionTo('');
                setNewConversionRatio('');
                setNewConversionNote('');
            };

            const deleteCustomConversion = (key) => {
                const updated = { ...customConversions };
                delete updated[key];
                setCustomConversions(updated);
                localStorage.setItem('customConversions', JSON.stringify(updated));
            };

            const startEditing = (key, value) => {
                setEditingKey(key);
                setEditValues({ to: value.to, ratio: value.ratio, note: value.note || '' });
            };

            const saveEdit = (oldKey) => {
                const updated = { ...customConversions };
                delete updated[oldKey];
                updated[oldKey] = {
                    to: editValues.to,
                    ratio: parseFloat(editValues.ratio),
                    note: editValues.note
                };
                setCustomConversions(updated);
                localStorage.setItem('customConversions', JSON.stringify(updated));
                setEditingKey(null);
            };

            const cancelEdit = () => {
                setEditingKey(null);
                setEditValues({ to: '', ratio: '', note: '' });
            };

            const isAmbiguous = (ingredient) => {
                const lowerIngredient = ingredient.ingredient.toLowerCase();
                return Object.keys(AMBIGUOUS_ITEMS).some(item => lowerIngredient.includes(item));
            };

            const getAmbiguityWarning = (ingredient) => {
                const lower = ingredient.ingredient.toLowerCase();
                
                // Find matching ambiguous term
                for (const [term, info] of Object.entries(AMBIGUOUS_ITEMS)) {
                    if (lower.includes(term)) {
                        // Check if user has defined this conversion
                        const hasConversion = Object.keys(customConversions).some(key => 
                            lower.includes(key.toLowerCase())
                        );
                        
                        if (hasConversion) {
                            return `${info.note} (~${info.measurement})`;
                        } else {
                            return `${info.note} - Define in Settings to convert`;
                        }
                    }
                }
                
                return 'Measurement may vary - Define in Settings';
            };

            const parseInput = () => {
                const lines = inputText.split('\n');
                const ingredients = [];
                const unparsed = [];
                
                for (const line of lines) {
                    if (line.trim()) {
                        const parsed = parseIngredient(line, rangeHandling);
                        if (parsed) {
                            ingredients.push(parsed);
                        } else {
                            unparsed.push(line.trim());
                        }
                    }
                }
                
                setParsedIngredients(ingredients);
                setUnparsedLines(unparsed);
            };

            const scaleIngredient = (ingredient, idx) => {
                // "To taste" items don't scale
                if (ingredient.type === 'seasoning') {
                    return { value: '', unit: 'to taste' };
                }
                
                // Handle empty servings values
                const origServings = originalServings === '' || originalServings <= 0 ? 1 : originalServings;
                const targServings = targetServings === '' || targetServings <= 0 ? 1 : targetServings;
                
                const scaleFactor = targServings / origServings;
                const scaledQuantity = ingredient.quantity * scaleFactor;
                
                // Check if this ingredient matches a custom conversion
                const lowerIngredient = ingredient.ingredient.toLowerCase();
                const lowerUnit = ingredient.unit.toLowerCase();
                
                // Try to find a matching conversion
                let matchedConversion = null;
                let bestMatchLength = 0;
                
                for (const [key, conversion] of Object.entries(customConversions)) {
                    const lowerKey = key.toLowerCase();
                    
                    // Build possible match strings
                    const unitIngredient = `${lowerUnit} ${lowerIngredient}`;
                    const ingredientUnit = `${lowerIngredient} ${lowerUnit}`;
                    
                    // Check various matching possibilities (prefer longer/more specific matches)
                    if (unitIngredient.includes(lowerKey) || 
                        ingredientUnit.includes(lowerKey) ||
                        lowerIngredient.includes(lowerKey) ||
                        lowerUnit === lowerKey) {
                        // Prefer longer matches (more specific)
                        if (lowerKey.length > bestMatchLength) {
                            matchedConversion = { key, ...conversion };
                            bestMatchLength = lowerKey.length;
                        }
                    }
                }
                
                // If we found a conversion, use it
                if (matchedConversion) {
                    const convertedValue = scaledQuantity * matchedConversion.ratio;
                    
                    // Return in the converted unit with original value for reference
                    return { 
                        value: convertedValue, 
                        unit: matchedConversion.to,
                        converted: true,
                        originalUnit: ingredient.unit,
                        originalScaledValue: scaledQuantity,
                        conversionKey: matchedConversion.key
                    };
                }
                
                const scaledBaseValue = ingredient.baseValue * scaleFactor;
                
                // Check if there's a unit override for this ingredient
                const overrideUnit = unitOverrides[idx];
                
                if (ingredient.type === 'volume') {
                    if (overrideUnit) {
                        // Convert to specific unit
                        const conversionFactor = VOLUME_CONVERSIONS[overrideUnit];
                        return { value: scaledBaseValue / conversionFactor, unit: overrideUnit };
                    }
                    return smartConvertVolume(scaledBaseValue, useMetric);
                } else if (ingredient.type === 'weight') {
                    if (overrideUnit) {
                        // Convert to specific unit
                        const conversionFactor = WEIGHT_CONVERSIONS[overrideUnit];
                        return { value: scaledBaseValue / conversionFactor, unit: overrideUnit };
                    }
                    return smartConvertWeight(scaledBaseValue, useMetric);
                } else if (ingredient.type === 'count') {
                    // For count items, just scale the number
                    return { value: scaledBaseValue, unit: '' };
                }
            };

            const getUnitOptions = (ingredient) => {
                if (ingredient.type === 'volume') {
                    if (useMetric) {
                        return ['ml', 'l'];
                    } else {
                        return ['tsp', 'tbsp', 'fl oz', 'cup', 'pt', 'qt', 'gal'];
                    }
                } else if (ingredient.type === 'weight') {
                    if (useMetric) {
                        return ['g', 'kg'];
                    } else {
                        return ['oz', 'lb'];
                    }
                }
                return [];
            };

            const setUnitOverride = (idx, unit) => {
                setUnitOverrides(prev => ({
                    ...prev,
                    [idx]: unit
                }));
            };

            const copyToClipboard = () => {
                if (parsedIngredients.length === 0) return;
                
                let text = `Recipe (${targetServings} servings)\n\n`;
                parsedIngredients.forEach((ingredient, idx) => {
                    const scaled = scaleIngredient(ingredient, idx);
                    let amount;
                    if (scaled.remainder && scaled.remainderUnit) {
                        amount = `${formatNumber(scaled.value)} ${scaled.unit} + ${formatNumber(scaled.remainder)} ${scaled.remainderUnit}`;
                    } else {
                        amount = `${formatNumber(scaled.value)}${scaled.unit ? ' ' + scaled.unit : ''}`;
                    }
                    text += `${amount} ${ingredient.ingredient}\n`;
                });
                
                navigator.clipboard.writeText(text).then(() => {
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            };

            const saveRecipe = () => {
                if (!recipeName.trim()) {
                    alert('Please enter a recipe name');
                    return;
                }
                
                const recipe = {
                    id: Date.now(),
                    name: recipeName,
                    servings: originalServings,
                    ingredients: inputText,
                    date: new Date().toISOString()
                };
                
                const updated = [...savedRecipes, recipe];
                setSavedRecipes(updated);
                localStorage.setItem('savedRecipes', JSON.stringify(updated));
                setRecipeName('');
                alert('Recipe saved!');
            };

            const loadRecipe = (recipe) => {
                setInputText(recipe.ingredients);
                setOriginalServings(recipe.servings);
                setTargetServings(recipe.servings);
                setShowSaved(false);
                parseInput();
            };

            const deleteRecipe = (id) => {
                const updated = savedRecipes.filter(r => r.id !== id);
                setSavedRecipes(updated);
                localStorage.setItem('savedRecipes', JSON.stringify(updated));
            };

            useEffect(() => {
                if (inputText) {
                    parseInput();
                }
            }, [inputText, rangeHandling]);

            return (
                <div className="min-h-screen bg-gray-900 p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Header with Navigation */}
                        <div className="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-green-400 mb-1 md:mb-2">Smart Recipe Scaler</h1>
                                    <p className="text-sm md:text-base text-gray-400 hidden sm:block">Scale recipes with intelligent unit conversions</p>
                                </div>
                                
                                {/* Desktop Navigation */}
                                <div className="hidden md:flex gap-2">
                                    <button
                                        onClick={() => setCurrentPage('scaler')}
                                        className={`px-6 py-2 rounded font-semibold ${
                                            currentPage === 'scaler'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        Recipe Scaler
                                    </button>
                                    <button
                                        onClick={() => setCurrentPage('settings')}
                                        className={`px-6 py-2 rounded font-semibold ${
                                            currentPage === 'settings'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        ⚙ Settings
                                    </button>
                                </div>
                                
                                {/* Mobile Hamburger Menu */}
                                <button
                                    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                                    className="md:hidden p-2 rounded bg-gray-700 hover:bg-gray-600"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        {mobileMenuOpen ? (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        ) : (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                        )}
                                    </svg>
                                </button>
                            </div>
                            
                            {/* Mobile Menu Dropdown */}
                            {mobileMenuOpen && (
                                <div className="md:hidden mt-4 flex flex-col gap-2">
                                    <button
                                        onClick={() => {
                                            setCurrentPage('scaler');
                                            setMobileMenuOpen(false);
                                        }}
                                        className={`px-4 py-3 rounded font-semibold text-left ${
                                            currentPage === 'scaler'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-300'
                                        }`}
                                    >
                                        📊 Recipe Scaler
                                    </button>
                                    <button
                                        onClick={() => {
                                            setCurrentPage('settings');
                                            setMobileMenuOpen(false);
                                        }}
                                        className={`px-4 py-3 rounded font-semibold text-left ${
                                            currentPage === 'settings'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-300'
                                        }`}
                                    >
                                        ⚙ Settings
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Settings Page */}
                        {currentPage === 'settings' && (
                            <div className="bg-gray-800 rounded-lg shadow-xl p-6">
                                <h2 className="text-2xl font-bold text-green-400 mb-6">Settings</h2>
                                
                                {/* Custom Conversions Section */}
                                <div className="mb-8">
                                    <h3 className="text-xl font-bold text-green-400 mb-3">Custom Conversions</h3>
                                    <p className="text-gray-400 mb-4">
                                        Define bidirectional conversions for ambiguous measurements. Once set, conversions work automatically in both directions. 
                                        For example, defining "1 garlic bulb ⇄ 10 cloves" lets you convert bulbs to cloves OR cloves to bulbs.
                                    </p>
                                    
                                    <div className="bg-gray-700 p-6 rounded-lg mb-4">
                                        <h4 className="font-semibold text-gray-200 mb-3">Add New Conversion</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Unit A</label>
                                                <input
                                                    type="text"
                                                    value={newConversionFrom}
                                                    onChange={(e) => setNewConversionFrom(e.target.value)}
                                                    placeholder="e.g., garlic bulb"
                                                    className="w-full bg-gray-600 text-gray-100 p-2 rounded border border-gray-500 focus:border-green-400 focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Unit B</label>
                                                <input
                                                    type="text"
                                                    value={newConversionTo}
                                                    onChange={(e) => setNewConversionTo(e.target.value)}
                                                    placeholder="e.g., cloves"
                                                    className="w-full bg-gray-600 text-gray-100 p-2 rounded border border-gray-500 focus:border-green-400 focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Ratio</label>
                                                <input
                                                    type="number"
                                                    value={newConversionRatio}
                                                    onChange={(e) => setNewConversionRatio(e.target.value)}
                                                    placeholder="e.g., 10"
                                                    step="0.1"
                                                    className="w-full bg-gray-600 text-gray-100 p-2 rounded border border-gray-500 focus:border-green-400 focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Note (Optional)</label>
                                                <input
                                                    type="text"
                                                    value={newConversionNote}
                                                    onChange={(e) => setNewConversionNote(e.target.value)}
                                                    placeholder="e.g., Varies by size"
                                                    className="w-full bg-gray-600 text-gray-100 p-2 rounded border border-gray-500 focus:border-green-400 focus:outline-none"
                                                />
                                            </div>
                                            <div className="flex items-end">
                                                <button
                                                    onClick={addCustomConversion}
                                                    className="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold"
                                                >
                                                    Add Conversion
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-2">
                                            Example: 1 "garlic bulb" ⇄ 10 "cloves" means enter bulb as Unit A, cloves as Unit B, ratio 10. Works both ways automatically.
                                        </p>
                                    </div>
                                    
                                    {/* Existing Conversions */}
                                    <div className="bg-gray-700 p-6 rounded-lg">
                                        <div className="flex justify-between items-center mb-3">
                                            <h4 className="font-semibold text-gray-200">Your Conversions</h4>
                                            <button
                                                onClick={() => {
                                                    if (confirm('Load default conversions? This will add common measurements (existing conversions will be kept).')) {
                                                        const defaultConversions = {
                                                            // Imprecise Measurements
                                                            'pinch': { to: 'tsp', ratio: 0.0625, note: '~1/16 tsp, thumb + forefinger' },
                                                            'dash': { to: 'tsp', ratio: 0.125, note: '~1/8 tsp' },
                                                            'smidgen': { to: 'tsp', ratio: 0.03125, note: '~1/32 tsp, half a pinch' },
                                                            'drop': { to: 'ml', ratio: 0.05, note: 'Literal droplet' },
                                                            'hint': { to: 'tsp', ratio: 0.04, note: '~1/32-1/16 tsp, very small' },
                                                            'sprinkle': { to: 'tsp', ratio: 0.5, note: '1 pinch to 1 tsp, varies' },
                                                            'dusting': { to: 'tsp', ratio: 1.5, note: 'Thin layer, 1-2 tsp' },
                                                            'drizzle': { to: 'tsp', ratio: 1.5, note: 'Thin liquid stream' },
                                                            'splash': { to: 'tsp', ratio: 1.5, note: 'Liquids like vinegar or wine' },
                                                            'glug': { to: 'tbsp', ratio: 1.5, note: 'Sound-based, usually olive oil' },
                                                            'handful': { to: 'cup', ratio: 0.5, note: "1/4 to 1 cup, depends on hand" },
                                                            'heaping teaspoon': { to: 'tsp', ratio: 1.15, note: '10-20% over level' },
                                                            'heaping tablespoon': { to: 'tbsp', ratio: 1.15, note: '10-20% over level' },
                                                            'rounded tablespoon': { to: 'tbsp', ratio: 1.25, note: 'Similar to heaping' },
                                                            'scant teaspoon': { to: 'tsp', ratio: 0.85, note: '10-20% under level' },
                                                            'scant tablespoon': { to: 'tbsp', ratio: 0.85, note: '10-20% under level' },
                                                            'scant cup': { to: 'fl oz', ratio: 7.5, note: 'Just under 8 oz' },
                                                            'garlic clove': { to: 'g', ratio: 5, note: '3-7g each, varies by size' },
                                                            'garlic bulb': { to: 'cloves', ratio: 12, note: '10-15 cloves typical' },
                                                            'garlic head': { to: 'cloves', ratio: 12, note: 'Same as bulb' },
                                                            'knob of ginger': { to: 'tbsp grated', ratio: 1.5, note: 'Thumb-sized piece (10-20g)' },
                                                            'knob ginger': { to: 'tbsp grated', ratio: 1.5, note: 'Thumb-sized piece (10-20g)' },
                                                            'sprig': { to: 'tsp chopped', ratio: 1, note: '2-4 in long (thyme, rosemary)' },
                                                            'bunch parsley': { to: 'oz', ratio: 1.5, note: '1-2 oz (30-60g), very inconsistent' },
                                                            'bunch cilantro': { to: 'oz', ratio: 1.5, note: '1-2 oz (30-60g), very inconsistent' },
                                                            'bunch basil': { to: 'oz', ratio: 1.5, note: '1-2 oz (30-60g), very inconsistent' },
                                                            'basil leaf': { to: 'g', ratio: 0.75, note: '0.5-1g each' },
                                                            'mint leaf': { to: 'g', ratio: 0.75, note: '0.5-1g each' },
                                                            'stick of butter': { to: 'cup', ratio: 0.5, note: 'U.S. standard (113g)' },
                                                            'stick butter': { to: 'tbsp', ratio: 8, note: 'U.S. standard (113g)' },
                                                            'cube of butter': { to: 'tbsp', ratio: 1, note: 'Often 1 tbsp piece (14g)' },
                                                            'rasher': { to: 'slice', ratio: 1, note: 'Common in UK/Canada for bacon' },
                                                            'small onion': { to: 'cup chopped', ratio: 0.75, note: 'Diced' },
                                                            'medium onion': { to: 'cup chopped', ratio: 1.5, note: 'Diced' },
                                                            'large onion': { to: 'cup chopped', ratio: 2, note: 'Diced' },
                                                            'small carrot': { to: 'cup chopped', ratio: 0.33, note: 'Diced' },
                                                            'medium carrot': { to: 'cup chopped', ratio: 0.5, note: 'Diced' },
                                                            'large carrot': { to: 'cup chopped', ratio: 0.75, note: 'Diced' },
                                                            'small lemon': { to: 'tbsp juice', ratio: 2, note: 'Fresh lemon' },
                                                            'medium lemon': { to: 'tbsp juice', ratio: 3, note: 'Fresh lemon' },
                                                            'large lemon': { to: 'tbsp juice', ratio: 4, note: 'Fresh lemon' },
                                                            'medium lime': { to: 'tbsp juice', ratio: 2, note: 'Fresh lime' },
                                                            'can tomatoes': { to: 'oz', ratio: 14.5, note: 'Standard can size' },
                                                            'small can': { to: 'oz', ratio: 8, note: 'Typical small can' },
                                                        };
                                                        const merged = { ...customConversions, ...defaultConversions };
                                                        setCustomConversions(merged);
                                                        localStorage.setItem('customConversions', JSON.stringify(merged));
                                                    }
                                                }}
                                                className="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm"
                                            >
                                                Load Defaults
                                            </button>
                                        </div>
                                        {Object.keys(customConversions).length > 0 ? (
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="border-b border-gray-500">
                                                            <th className="text-left p-2 text-gray-400">Unit A</th>
                                                            <th className="text-left p-2 text-gray-400">Ratio</th>
                                                            <th className="text-left p-2 text-gray-400">Unit B</th>
                                                            <th className="text-left p-2 text-gray-400">Note</th>
                                                            <th className="text-right p-2 text-gray-400">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {Object.entries(customConversions).map(([key, value]) => (
                                                            <tr key={key} className="border-b border-gray-600 hover:bg-gray-600">
                                                                {editingKey === key ? (
                                                                    <>
                                                                        <td className="p-2">
                                                                            <span className="text-green-400 font-semibold">{key}</span>
                                                                        </td>
                                                                        <td className="p-2">
                                                                            <input
                                                                                type="number"
                                                                                value={editValues.ratio}
                                                                                onChange={(e) => setEditValues({...editValues, ratio: e.target.value})}
                                                                                className="w-20 bg-gray-800 text-gray-100 p-1 rounded border border-gray-500 text-sm"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2">
                                                                            <input
                                                                                type="text"
                                                                                value={editValues.to}
                                                                                onChange={(e) => setEditValues({...editValues, to: e.target.value})}
                                                                                className="w-full bg-gray-800 text-gray-100 p-1 rounded border border-gray-500 text-sm"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2">
                                                                            <input
                                                                                type="text"
                                                                                value={editValues.note}
                                                                                onChange={(e) => setEditValues({...editValues, note: e.target.value})}
                                                                                className="w-full bg-gray-800 text-gray-100 p-1 rounded border border-gray-500 text-sm"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 text-right">
                                                                            <button
                                                                                onClick={() => saveEdit(key)}
                                                                                className="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs mr-1"
                                                                            >
                                                                                Save
                                                                            </button>
                                                                            <button
                                                                                onClick={cancelEdit}
                                                                                className="px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs"
                                                                            >
                                                                                Cancel
                                                                            </button>
                                                                        </td>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <td className="p-2">
                                                                            <span className="text-green-400 font-semibold">{key}</span>
                                                                        </td>
                                                                        <td className="p-2">{value.ratio}</td>
                                                                        <td className="p-2">
                                                                            <span className="text-green-400 font-semibold">{value.to}</span>
                                                                        </td>
                                                                        <td className="p-2 text-gray-400 text-xs">{value.note}</td>
                                                                        <td className="p-2 text-right whitespace-nowrap">
                                                                            <button
                                                                                onClick={() => startEditing(key, value)}
                                                                                className="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs mr-1"
                                                                            >
                                                                                Edit
                                                                            </button>
                                                                            <button
                                                                                onClick={() => deleteCustomConversion(key)}
                                                                                className="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs"
                                                                            >
                                                                                Del
                                                                            </button>
                                                                        </td>
                                                                    </>
                                                                )}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ) : (
                                            <p className="text-gray-500 italic text-center py-8">
                                                No custom conversions yet. Add conversions above to handle ambiguous measurements like "1 garlic bulb", "1 pinch salt", or "1 medium onion".
                                                <br/><br/>
                                                When you paste recipes with these terms, the app will warn you they're ambiguous and prompt you to define them here.
                                            </p>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Common Examples Section */}
                                <div className="bg-gray-700 p-6 rounded-lg">
                                    <h4 className="font-semibold text-gray-200 mb-3">💡 Common Conversion Examples</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-300">
                                        <div>• 1 garlic bulb ⇄ 10-12 cloves</div>
                                        <div>• 1 medium onion ⇄ 1.5 cups chopped</div>
                                        <div>• 1 large onion ⇄ 2 cups chopped</div>
                                        <div>• 1 bunch parsley ⇄ 1 cup chopped</div>
                                        <div>• 1 medium lemon ⇄ 3 tbsp juice</div>
                                        <div>• 1 can tomatoes ⇄ 14.5 oz</div>
                                        <div>• 1 bunch basil ⇄ 0.5 cup chopped</div>
                                        <div>• 1 medium carrot ⇄ 0.5 cup chopped</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Recipe Scaler Page */}
                        {currentPage === 'scaler' && (
                            <>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Input Section */}
                            <div className="bg-gray-800 rounded-lg shadow-xl p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-green-400">Input</h2>
                                    <button
                                        onClick={() => setShowSaved(!showSaved)}
                                        className="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm"
                                    >
                                        {showSaved ? 'Hide' : 'Saved Recipes'}
                                    </button>
                                </div>

                                {showSaved && (
                                    <div className="mb-4 p-4 bg-gray-700 rounded max-h-64 overflow-y-auto">
                                        {savedRecipes.length === 0 ? (
                                            <p className="text-gray-400">No saved recipes</p>
                                        ) : (
                                            savedRecipes.map(recipe => (
                                                <div key={recipe.id} className="mb-2 p-2 bg-gray-600 rounded flex justify-between items-center">
                                                    <div>
                                                        <div className="font-bold">{recipe.name}</div>
                                                        <div className="text-sm text-gray-400">{recipe.servings} servings</div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => loadRecipe(recipe)}
                                                            className="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-sm"
                                                        >
                                                            Load
                                                        </button>
                                                        <button
                                                            onClick={() => deleteRecipe(recipe.id)}
                                                            className="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-sm"
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}

                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm text-gray-400">Paste ingredients here</label>
                                    {inputText && (
                                        <button
                                            onClick={() => {
                                                setInputText('');
                                                setParsedIngredients([]);
                                                setUnparsedLines([]);
                                                setUnitOverrides({});
                                            }}
                                            className="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm"
                                        >
                                            Clear Input
                                        </button>
                                    )}
                                </div>

                                <textarea
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="Paste ingredients here... (e.g., 2 cups flour, 1/2 tsp salt, 250g sugar)"
                                    className="w-full h-64 bg-gray-700 text-gray-100 p-3 rounded border border-gray-600 focus:border-green-400 focus:outline-none font-mono text-sm"
                                />

                                <div className="mt-4 grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Original Servings</label>
                                        <input
                                            type="number"
                                            value={originalServings}
                                            onChange={(e) => setOriginalServings(e.target.value === '' ? '' : Number(e.target.value))}
                                            min="1"
                                            className="w-full bg-gray-700 text-gray-100 p-2 rounded border border-gray-600 focus:border-green-400 focus:outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Target Servings</label>
                                        <input
                                            type="number"
                                            value={targetServings}
                                            onChange={(e) => setTargetServings(e.target.value === '' ? '' : Number(e.target.value))}
                                            min="1"
                                            className="w-full bg-gray-700 text-gray-100 p-2 rounded border border-gray-600 focus:border-green-400 focus:outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="mt-4 flex items-center justify-between">
                                    <label className="flex items-center cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={useMetric}
                                            onChange={(e) => setUseMetric(e.target.checked)}
                                            className="mr-2"
                                        />
                                        <span className="text-sm text-gray-400">Use Metric Units</span>
                                    </label>
                                    
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm text-gray-400">Ranges:</span>
                                        <select
                                            value={rangeHandling}
                                            onChange={(e) => setRangeHandling(e.target.value)}
                                            className="bg-gray-700 text-gray-100 px-2 py-1 rounded border border-gray-600 focus:border-green-400 focus:outline-none text-sm"
                                        >
                                            <option value="low">Low (1-2 → 1)</option>
                                            <option value="average">Average (1-2 → 1.5)</option>
                                            <option value="high">High (1-2 → 2)</option>
                                        </select>
                                    </div>
                                </div>

                                <div className="mt-4 flex gap-2">
                                    <input
                                        type="text"
                                        value={recipeName}
                                        onChange={(e) => setRecipeName(e.target.value)}
                                        placeholder="Recipe name (optional)"
                                        className="flex-1 bg-gray-700 text-gray-100 p-2 rounded border border-gray-600 focus:border-green-400 focus:outline-none"
                                    />
                                    <button
                                        onClick={saveRecipe}
                                        className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold"
                                    >
                                        Save Recipe
                                    </button>
                                </div>
                            </div>

                            {/* Output Section */}
                            <div className="bg-gray-800 rounded-lg shadow-xl p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-green-400">
                                        Scaled Recipe ({targetServings} servings)
                                    </h2>
                                    {parsedIngredients.length > 0 && (
                                        <button
                                            onClick={copyToClipboard}
                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold text-sm flex items-center gap-2"
                                        >
                                            {copySuccess ? '✓ Copied!' : '📋 Copy Recipe'}
                                        </button>
                                    )}
                                </div>

                                {parsedIngredients.length === 0 ? (
                                    <div className="text-gray-400 text-center py-8">
                                        Paste ingredients to see scaled results
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {parsedIngredients.map((ingredient, idx) => {
                                            const scaled = scaleIngredient(ingredient, idx);
                                            const unitOptions = getUnitOptions(ingredient);
                                            const showWarning = isAmbiguous(ingredient);
                                            return (
                                                <div key={idx} className="bg-gray-700 p-3 rounded">
                                                    <div className="flex justify-between items-start gap-3">
                                                        <div className="flex-1">
                                                            {ingredient.type === 'seasoning' ? (
                                                                <>
                                                                    <span className="text-gray-100">{ingredient.ingredient}</span>
                                                                    <span className="text-gray-400 ml-2 italic text-sm">to taste</span>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span className="text-green-400 font-bold">
                                                                        {formatCompoundMeasurement(scaled)}
                                                                    </span>
                                                                    <span className="text-gray-100 ml-2">
                                                                        {ingredient.ingredient}
                                                                    </span>
                                                                    {scaled.converted && scaled.originalScaledValue && (
                                                                        <span className="ml-2 text-xs text-blue-400">
                                                                            (or {formatNumber(scaled.originalScaledValue)} {pluralize(scaled.originalScaledValue, scaled.originalUnit === 'count' ? ingredient.ingredient.split(' ')[0] : scaled.originalUnit)})
                                                                        </span>
                                                                    )}
                                                                </>
                                                            )}
                                                            {ingredient.isRange && ingredient.rangeOriginal && (
                                                                <span className="ml-2 text-xs text-yellow-400" title={`Original range: ${ingredient.rangeOriginal} ${ingredient.unit}`}>
                                                                    [from {ingredient.rangeOriginal} {ingredient.unit !== 'count' ? ingredient.unit : ''}]
                                                                </span>
                                                            )}
                                                            {showWarning && (
                                                                <div className="mt-1 text-xs text-orange-400 flex items-center gap-1">
                                                                    <span title={getAmbiguityWarning(ingredient)}>
                                                                        ⚠️ {getAmbiguityWarning(ingredient)} - adjust to taste
                                                                    </span>
                                                                </div>
                                                            )}
                                                            {ingredient.notes && (
                                                                <span className="ml-2 text-xs text-gray-500">
                                                                    {ingredient.notes}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {unitOptions.length > 0 && (
                                                                <select
                                                                    value={unitOverrides[idx] || 'auto'}
                                                                    onChange={(e) => setUnitOverride(idx, e.target.value === 'auto' ? null : e.target.value)}
                                                                    className="bg-gray-600 text-gray-100 px-2 py-1 rounded border border-gray-500 focus:border-green-400 focus:outline-none text-xs"
                                                                    title="Change unit"
                                                                >
                                                                    <option value="auto">Auto</option>
                                                                    {unitOptions.map(unit => (
                                                                        <option key={unit} value={unit}>{unit}</option>
                                                                    ))}
                                                                </select>
                                                            )}
                                                            <div className="text-xs text-gray-500 whitespace-nowrap">
                                                                {ingredient.type !== 'seasoning' && `${ingredient.quantity} ${ingredient.unit}`}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        
                                        {unparsedLines.length > 0 && (
                                            <div className="mt-4 p-3 bg-red-900/30 border border-red-700 rounded">
                                                <div className="text-red-400 font-bold mb-2">⚠ Couldn't parse these lines:</div>
                                                {unparsedLines.map((line, idx) => (
                                                    <div key={idx} className="text-red-300 text-sm font-mono">• {line}</div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {parsedIngredients.length > 0 && (
                                    <div className="mt-4 p-3 bg-gray-700 rounded text-sm text-gray-400">
                                        <div>Parsed: {parsedIngredients.length} ingredients</div>
                                        <div>Scale factor: {((targetServings || 1) / (originalServings || 1)).toFixed(2)}x</div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="mt-6 bg-gray-800 rounded-lg shadow-xl p-4 text-sm text-gray-400">
                            <strong className="text-green-400">Tips:</strong>
                            <ul className="mt-2 space-y-1 list-disc list-inside">
                                <li>Supports formats like: "2 cups flour", "1/2 tsp salt", "2 1/2 cups water", "250g sugar", "3 eggs"</li>
                                <li>Handles whole items: "2 potatoes", "1 onion", "4 chicken breasts"</li>
                                <li>Handles messy copy-paste - ignores extra text and instructions</li>
                                <li>Smart unit conversion: 96 tsp → 2 cups (or metric equivalent)</li>
                                <li>Supports ranges: "1-2 cups" or "2-3 eggs" - see original range in yellow text</li>
                                <li>Mixed fractions: "2 1/2 cups" works perfectly</li>
                            </ul>
                        </div>
                        </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<RecipeScaler />, document.getElementById('root'));
    </script>
</body>
</html>
